const axios = require("axios");
const fs = require("fs-extra");

module.exports = {
    config: {
        name: "dogfact",
        aliases: [],
        version: "1.0.0",
        author: "ğ´ğ‘ ğ‘–ğ‘“ ğ‘€ğ‘â„ğ‘šğ‘¢ğ‘‘",
        countDown: 5,
        role: 0,
        category: "fun",
        shortDescription: {
            en: "ğ–±ğ–ºğ—‡ğ–½ğ—ˆğ—† ğ–½ğ—ˆğ—€ ğ—‚ğ—†ğ–ºğ—€ğ–¾ğ—Œ ğ—ğ—‚ğ—ğ— ğ—‚ğ—‡ğ—ğ–¾ğ—‹ğ–¾ğ—Œğ—ğ—‚ğ—‡ğ—€ ğ–¿ğ–ºğ–¼ğ—ğ—Œ"
        },
        longDescription: {
            en: "ğ–¦ğ–¾ğ— ğ—‹ğ–ºğ—‡ğ–½ğ—ˆğ—† ğ–½ğ—ˆğ—€ ğ—‚ğ—†ğ–ºğ—€ğ–¾ğ—Œ ğ—ğ—‚ğ—ğ— ğ—‚ğ—‡ğ—ğ–¾ğ—‹ğ–¾ğ—Œğ—ğ—‚ğ—‡ğ—€ ğ–¿ğ–ºğ–¼ğ—ğ—Œ ğ–ºğ–»ğ—ˆğ—ğ— ğ–½ğ—ˆğ—€ğ—Œ"
        },
        guide: {
            en: "{p}dogfact"
        },
        dependencies: {
            "axios": "",
            "fs-extra": ""
        }
    },

    onStart: async function({ message, event }) {
        try {
            // Dependency check
            let dependenciesAvailable = true;
            try {
                require("axios");
                require("fs-extra");
            } catch (e) {
                dependenciesAvailable = false;
            }

            if (!dependenciesAvailable) {
                return message.reply("âŒ ğ–¬ğ—‚ğ—Œğ—Œğ—‚ğ—‡ğ—€ ğ–½ğ–¾ğ—‰ğ–¾ğ—‡ğ–½ğ–¾ğ—‡ğ–¼ğ—‚ğ–¾ğ—Œ. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—‚ğ—‡ğ—Œğ—ğ–ºğ—…ğ—… ğ–ºğ—‘ğ—‚ğ—ˆğ—Œ ğ–ºğ—‡ğ–½ ğ–¿ğ—Œ-ğ–¾ğ—‘ğ—ğ—‹ğ–º.");
            }

            const { threadID, messageID } = event;

            const loadingMsg = await message.reply("â³ ğ–¥ğ–¾ğ—ğ–¼ğ—ğ—‚ğ—‡ğ—€ ğ–½ğ—ˆğ—€ ğ–¿ğ–ºğ–¼ğ—...");

            try {
                const res = await axios.get(`https://some-random-api.com/animal/dog`, {
                    timeout: 30000,
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });

                if (!res.data || !res.data.image || !res.data.fact) {
                    throw new Error("ğ–¨ğ—‡ğ—ğ–ºğ—…ğ—‚ğ–½ ğ–½ğ–ºğ—ğ–º ğ—‹ğ–¾ğ–¼ğ–¾ğ—‚ğ—ğ–¾ğ–½ ğ–¿ğ—‹ğ—ˆğ—† ğ– ğ–¯ğ–¨");
                }

                const data = res.data;

                const imageResponse = await axios.get(data.image, { 
                    responseType: 'arraybuffer',
                    timeout: 30000,
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    },
                    maxContentLength: 10 * 1024 * 1024 // 10MB limit
                });

                // Check content type
                const contentType = imageResponse.headers['content-type'];
                if (!contentType || !contentType.startsWith('image/')) {
                    throw new Error("ğ–¨ğ—‡ğ—ğ–ºğ—…ğ—‚ğ–½ ğ—‚ğ—†ğ–ºğ—€ğ–¾ ğ–¼ğ—ˆğ—‡ğ—ğ–¾ğ—‡ğ— ğ—ğ—’ğ—‰ğ–¾");
                }

                const imagePath = __dirname + `/cache/dog_${Date.now()}.png`;
                await fs.writeFileSync(imagePath, Buffer.from(imageResponse.data, 'binary'));

                // Verify file was written
                const stats = await fs.stat(imagePath);
                if (stats.size < 1000) {
                    throw new Error("ğ–¨ğ—†ğ–ºğ—€ğ–¾ ğ–¿ğ—‚ğ—…ğ–¾ ğ—‚ğ—Œ ğ—ğ—ˆğ—ˆ ğ—Œğ—†ğ–ºğ—…ğ—…");
                }

                // Delete loading message
                try {
                    await message.unsendMessage(loadingMsg.messageID);
                } catch (unsendError) {
                    console.warn("ğ–¢ğ—ˆğ—ğ—…ğ–½ ğ—‡ğ—ˆğ— ğ—ğ—‡ğ—Œğ–¾ğ—‡ğ–½ ğ—…ğ—ˆğ–ºğ–½ğ—‚ğ—‡ğ—€ ğ—†ğ–¾ğ—Œğ—Œğ–ºğ—€ğ–¾:", unsendError.message);
                }

                await message.reply({
                    body: `ğŸ¶ | ğ–£ğ—ˆğ—€ ğ–¥ğ–ºğ–¼ğ—:\n${data.fact}`,
                    attachment: fs.createReadStream(imagePath)
                });

                // Clean up file
                try {
                    if (fs.existsSync(imagePath)) {
                        fs.unlinkSync(imagePath);
                    }
                } catch (cleanupError) {
                    console.warn("ğ–¢ğ—ˆğ—ğ—…ğ–½ ğ—‡ğ—ˆğ— ğ–½ğ–¾ğ—…ğ–¾ğ—ğ–¾ ğ—ğ–¾ğ—†ğ—‰ğ—ˆğ—‹ğ–ºğ—‹ğ—’ ğ–¿ğ—‚ğ—…ğ–¾:", cleanupError.message);
                }
                
            } catch (apiError) {
                // Delete loading message
                try {
                    await message.unsendMessage(loadingMsg.messageID);
                } catch (unsendError) {
                    console.warn("ğ–¢ğ—ˆğ—ğ—…ğ–½ ğ—‡ğ—ˆğ— ğ—ğ—‡ğ—Œğ–¾ğ—‡ğ–½ ğ—…ğ—ˆğ–ºğ–½ğ—‚ğ—‡ğ—€ ğ—†ğ–¾ğ—Œğ—Œğ–ºğ—€ğ–¾:", unsendError.message);
                }

                console.error("âŒ ğ–£ğ—ˆğ—€ğ–¥ğ–ºğ–¼ğ— ğ– ğ–¯ğ–¨ ğ–¤ğ—‹ğ—‹ğ—ˆğ—‹:", apiError.message);
                
                let errorMessage = "âŒ ğ–¥ğ–ºğ—‚ğ—…ğ–¾ğ–½ ğ—ğ—ˆ ğ–¿ğ–¾ğ—ğ–¼ğ— ğ–½ğ—ˆğ—€ ğ–¿ğ–ºğ–¼ğ—. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡ ğ—…ğ–ºğ—ğ–¾ğ—‹.";
                
                if (apiError.code === 'ECONNREFUSED') {
                    errorMessage = "âŒ ğ–­ğ–¾ğ—ğ—ğ—ˆğ—‹ğ—„ ğ–¾ğ—‹ğ—‹ğ—ˆğ—‹. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ–¼ğ—ğ–¾ğ–¼ğ—„ ğ—’ğ—ˆğ—ğ—‹ ğ—‚ğ—‡ğ—ğ–¾ğ—‹ğ—‡ğ–¾ğ— ğ–¼ğ—ˆğ—‡ğ—‡ğ–¾ğ–¼ğ—ğ—‚ğ—ˆğ—‡.";
                } else if (apiError.code === 'ETIMEDOUT') {
                    errorMessage = "âŒ ğ–±ğ–¾ğ—Šğ—ğ–¾ğ—Œğ— ğ—ğ—‚ğ—†ğ–¾ğ–½ ğ—ˆğ—ğ—. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡.";
                } else if (apiError.message.includes('maxContentLength')) {
                    errorMessage = "âŒ ğ–¨ğ—†ğ–ºğ—€ğ–¾ ğ—‚ğ—Œ ğ—ğ—ˆğ—ˆ ğ—…ğ–ºğ—‹ğ—€ğ–¾. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡.";
                } else if (apiError.message.includes('content type')) {
                    errorMessage = "âŒ ğ–¨ğ—‡ğ—ğ–ºğ—…ğ—‚ğ–½ ğ—‚ğ—†ğ–ºğ—€ğ–¾ ğ–¿ğ—ˆğ—‹ğ—†ğ–ºğ—. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡.";
                }
                
                await message.reply(errorMessage);
            }

        } catch (error) {
            console.error("ğŸ’¥ ğ–£ğ—ˆğ—€ğ–¥ğ–ºğ–¼ğ— ğ–¤ğ—‹ğ—‹ğ—ˆğ—‹:", error);
            
            let errorMessage = "âŒ ğ– ğ—‡ ğ–¾ğ—‹ğ—‹ğ—ˆğ—‹ ğ—ˆğ–¼ğ–¼ğ—ğ—‹ğ—‹ğ–¾ğ–½. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡ ğ—…ğ–ºğ—ğ–¾ğ—‹.";
            
            if (error.message.includes('threadsData')) {
                errorMessage = "âŒ ğ–£ğ–ºğ—ğ–ºğ—Œğ—ğ—ˆğ—‹ğ–¾ ğ–¾ğ—‹ğ—‹ğ—ˆğ—‹. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ–¼ğ—ğ–¾ğ–¼ğ—„ ğ—ğ—ğ–¾ ğ–»ğ—ˆğ—'ğ—Œ ğ–¼ğ—ˆğ—‡ğ–¿ğ—‚ğ—€ğ—ğ—‹ğ–ºğ—ğ—‚ğ—ˆğ—‡.";
            } else if (error.message.includes('permission')) {
                errorMessage = "âŒ ğ–¯ğ–¾ğ—‹ğ—†ğ—‚ğ—Œğ—Œğ—‚ğ—ˆğ—‡ ğ–¾ğ—‹ğ—‹ğ—ˆğ—‹. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ–¼ğ—ğ–¾ğ–¼ğ—„ ğ–»ğ—ˆğ— ğ—‰ğ–¾ğ—‹ğ—†ğ—‚ğ—Œğ—Œğ—‚ğ—ˆğ—‡ğ—Œ.";
            }
            
            await message.reply(errorMessage);
        }
    }
};
