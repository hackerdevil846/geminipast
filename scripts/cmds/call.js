const axios = require('axios');

module.exports = {
    config: {
        name: "call",
        aliases: [],
        version: "1.0.1",
        author: "ğ´ğ‘ ğ‘–ğ‘“ ğ‘€ğ‘â„ğ‘šğ‘¢ğ‘‘",
        countDown: 30,
        role: 0,
        category: "utility",
        shortDescription: {
            en: "ğ–¢ğ–ºğ—…ğ—… ğ–»ğ—ˆğ—†ğ–»ğ–¾ğ—‹ (ğ–¤ğ–½ğ—ğ–¼ğ–ºğ—ğ—‚ğ—ˆğ—‡ğ–ºğ—… ğ—ğ—Œğ–¾ ğ—ˆğ—‡ğ—…ğ—’)"
        },
        longDescription: {
            en: "ğ–²ğ—‚ğ—†ğ—ğ—…ğ–ºğ—ğ–¾ğ—Œ ğ–¼ğ–ºğ—…ğ—… ğ–»ğ—ˆğ—†ğ–»ğ—‚ğ—‡ğ—€ ğ–¿ğ—ˆğ—‹ ğ–¡ğ–ºğ—‡ğ—€ğ—…ğ–ºğ–½ğ–¾ğ—Œğ—ğ—‚ ğ—‡ğ—ğ—†ğ–»ğ–¾ğ—‹ğ—Œ. ğ–´ğ—Œğ–¾ ğ—‹ğ–¾ğ—Œğ—‰ğ—ˆğ—‡ğ—Œğ—‚ğ–»ğ—…ğ—’."
        },
        guide: {
            en: "{p}call [01ğ—‘ğ—‘ğ—‘ğ—‘ğ—‘ğ—‘ğ—‘ğ—‘ğ—‘ğ—‘]"
        },
        dependencies: {
            "axios": ""
        }
    },

    onStart: async function ({ message, event, args }) {
        try {
            // Dependency check
            let dependenciesAvailable = true;
            try {
                require("axios");
            } catch (e) {
                dependenciesAvailable = false;
            }

            if (!dependenciesAvailable) {
                return message.reply("âŒ ğ–¬ğ—‚ğ—Œğ—Œğ—‚ğ—‡ğ—€ ğ–½ğ–¾ğ—‰ğ–¾ğ—‡ğ–½ğ–¾ğ—‡ğ–¼ğ—‚ğ–¾ğ—Œ. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—‚ğ—‡ğ—Œğ—ğ–ºğ—…ğ—… ğ–ºğ—‘ğ—‚ğ—ˆğ—Œ.");
            }

            const input = args[0];

            // Help message if no input
            if (!input) {
                return message.reply(
                    `ğŸ“ ğ–¢ğ–ºğ—…ğ—… ğ–¢ğ—ˆğ—†ğ—†ğ–ºğ—‡ğ–½ ğ–´ğ—Œğ–ºğ—€ğ–¾:\nÂ» {p}call [ğ—‰ğ—ğ—ˆğ—‡ğ–¾ ğ—‡ğ—ğ—†ğ–»ğ–¾ğ—‹]\n\nğ–¤ğ—‘ğ–ºğ—†ğ—‰ğ—…ğ–¾: {p}call 01712345678\n\nâ„¹ï¸ ğ–³ğ—ğ—‚ğ—Œ ğ—ğ—ˆğ—ˆğ—… ğ—‚ğ—Œ ğ–¿ğ—ˆğ—‹ ğ–¾ğ–½ğ—ğ–¼ğ–ºğ—ğ—‚ğ—ˆğ—‡ğ–ºğ—… ğ—‰ğ—ğ—‹ğ—‰ğ—ˆğ—Œğ–¾ğ—Œ ğ—ˆğ—‡ğ—…ğ—’. ğ–¬ğ—‚ğ—Œğ—ğ—Œğ–¾ ğ–¿ğ—ˆğ—‹ ğ—ğ–ºğ—‹ğ–ºğ—Œğ—Œğ—†ğ–¾ğ—‡ğ— ğ—‚ğ—Œ ğ—‚ğ—…ğ—…ğ–¾ğ—€ğ–ºğ—….`
                );
            }

            // Validate Bangladeshi phone number format
            if (!/^01[0-9]{9}$/.test(input)) {
                return message.reply(
                    "âŒ ğ–¨ğ—‡ğ—ğ–ºğ—…ğ—‚ğ–½ ğ–¿ğ—ˆğ—‹ğ—†ğ–ºğ—! ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—‰ğ—‹ğ—ˆğ—ğ—‚ğ–½ğ–¾ ğ–º ğ—ğ–ºğ—…ğ—‚ğ–½ ğ–¡ğ–ºğ—‡ğ—€ğ—…ğ–ºğ–½ğ–¾ğ—Œğ—ğ—‚ ğ—‡ğ—ğ—†ğ–»ğ–¾ğ—‹ (11 ğ–½ğ—‚ğ—€ğ—‚ğ—ğ—Œ ğ—Œğ—ğ–ºğ—‹ğ—ğ—‚ğ—‡ğ—€ ğ—ğ—‚ğ—ğ— '01')\n\nğ–¤ğ—‘ğ–ºğ—†ğ—‰ğ—…ğ–¾: 01712345678"
                );
            }

            // Check if number is from known test ranges (prevent accidental misuse)
            const testRanges = ['01700000000', '01800000000', '01900000000', '01600000000'];
            if (testRanges.some(range => input.startsWith(range.substring(0, 4)))) {
                return message.reply(
                    "âŒ ğ–³ğ–¾ğ—Œğ— ğ—‡ğ—ğ—†ğ–»ğ–¾ğ—‹ ğ—‹ğ–ºğ—‡ğ—€ğ–¾ ğ–½ğ–¾ğ—ğ–¾ğ–¼ğ—ğ–¾ğ–½. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—Œğ–¾ ğ–º ğ—‹ğ–¾ğ–ºğ—… ğ—‡ğ—ğ—†ğ–»ğ–¾ğ—‹ ğ—‚ğ–¿ ğ—ğ–¾ğ—Œğ—ğ—‚ğ—‡ğ—€."
                );
            }

            const processingMsg = await message.reply(
                `ğŸ“ ğ–¨ğ—‡ğ—‚ğ—ğ—‚ğ–ºğ—ğ—‚ğ—‡ğ—€ ğ–¼ğ–ºğ—…ğ—… ğ—Œğ–¾ğ—Šğ—ğ–¾ğ—‡ğ–¼ğ–¾ ğ—ğ—ˆ: ${input}\nâ±ï¸ ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ–ºğ—‚ğ— 90 ğ—Œğ–¾ğ–¼ğ—ˆğ—‡ğ–½ğ—Œ...\n\nâš ï¸ ğ–±ğ–¾ğ—†ğ—‚ğ—‡ğ–½ğ–¾ğ—‹: ğ–´ğ—Œğ–¾ ğ—‹ğ–¾ğ—Œğ—‰ğ—ˆğ—‡ğ—Œğ—‚ğ–»ğ—…ğ—’. ğ–´ğ—‡ğ–¾ğ—ğ—ğ—‚ğ–¼ğ–ºğ—… ğ—ğ—Œğ–¾ ğ—ğ—‚ğ—ˆğ—…ğ–ºğ—ğ–¾ğ—Œ ğ—…ğ–ºğ—ğ—Œ.`
            );

            let apiSuccess = false;
            let lastError = null;

            // Make API request to call service with error handling
            try {
                console.log(`ğŸ“ ğ– ğ—ğ—ğ–¾ğ—†ğ—‰ğ—ğ—‚ğ—‡ğ—€ ğ–¼ğ–ºğ—…ğ—… ğ—ğ—ˆ: ${input}`);
                
                const response = await axios.get(`https://tbblab.shop/callbomber.php?mobile=${input}`, {
                    timeout: 30000,
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });

                if (response.status === 200) {
                    apiSuccess = true;
                    console.log(`âœ… ğ–¢ğ–ºğ—…ğ—… ğ– ğ–¯ğ–¨ ğ—‹ğ–¾ğ—Œğ—‰ğ—ˆğ—‡ğ—Œğ–¾ ğ—Œğ—ğ–¼ğ–¼ğ–¾ğ—Œğ—Œğ–¿ğ—ğ—…`);
                } else {
                    throw new Error(`ğ– ğ–¯ğ–¨ ğ—‹ğ–¾ğ—ğ—ğ—‹ğ—‡ğ–¾ğ–½ ğ—Œğ—ğ–ºğ—ğ—ğ—Œ: ${response.status}`);
                }

            } catch (apiError) {
                lastError = apiError;
                console.error(`âŒ ğ–¢ğ–ºğ—…ğ—… ğ– ğ–¯ğ–¨ ğ–¾ğ—‹ğ—‹ğ—ˆğ—‹:`, apiError.message);
            }

            // Delete processing message after 90 seconds and send result
            setTimeout(async () => {
                try {
                    await message.unsendMessage(processingMsg.messageID);
                    
                    if (apiSuccess) {
                        await message.reply(
                            `âœ… ğ–²ğ—ğ–¼ğ–¼ğ–¾ğ—Œğ—Œğ–¿ğ—ğ—…ğ—…ğ—’ ğ–¼ğ—ˆğ—†ğ—‰ğ—…ğ–¾ğ—ğ–¾ğ–½ ğ–¼ğ–ºğ—…ğ—… ğ—Œğ–¾ğ—Šğ—ğ–¾ğ—‡ğ–¼ğ–¾ ğ—ğ—ˆ: ${input}\n\nğŸ“¢ ğ–¤ğ–½ğ—ğ–¼ğ–ºğ—ğ—‚ğ—ˆğ—‡ğ–ºğ—… ğ—‹ğ–¾ğ—†ğ—‚ğ—‡ğ–½ğ–¾ğ—‹:\nğ–³ğ—ğ—‚ğ—Œ ğ—Œğ—‚ğ—†ğ—ğ—…ğ–ºğ—ğ—‚ğ—ˆğ—‡ ğ–½ğ–¾ğ—†ğ—ˆğ—‡ğ—Œğ—ğ—‹ğ–ºğ—ğ–¾ğ—Œ ğ—Œğ–¾ğ–¼ğ—ğ—‹ğ—‚ğ—ğ—’ ğ—ğ—ğ—…ğ—‡ğ–¾ğ—‹ğ–ºğ–»ğ—‚ğ—…ğ—‚ğ—ğ—‚ğ–¾ğ—Œ. ğ– ğ—…ğ—ğ–ºğ—’ğ—Œ ğ—‹ğ–¾ğ—Œğ—‰ğ–¾ğ–¼ğ— ğ—‰ğ—‹ğ—‚ğ—ğ–ºğ–¼ğ—’ ğ—…ğ–ºğ—ğ—Œ ğ–ºğ—‡ğ–½ ğ—ğ—Œğ–¾ ğ—„ğ—‡ğ—ˆğ—ğ—…ğ–¾ğ–½ğ—€ğ–¾ ğ–¾ğ—ğ—ğ—‚ğ–¼ğ–ºğ—…ğ—…ğ—’.`
                        );
                    } else {
                        await message.reply(
                            `âŒ ğ–¥ğ–ºğ—‚ğ—…ğ–¾ğ–½ ğ—ğ—ˆ ğ—‚ğ—‡ğ—‚ğ—ğ—‚ğ–ºğ—ğ–¾ ğ–¼ğ–ºğ—…ğ—…ğ—Œ: ${lastError?.message || 'ğ–´ğ—‡ğ—„ğ—‡ğ—ˆğ—ğ—‡ ğ–¾ğ—‹ğ—‹ğ—ˆğ—‹'}\n\nğ–¯ğ—ˆğ—Œğ—Œğ—‚ğ–»ğ—…ğ–¾ ğ—‹ğ–¾ğ–ºğ—Œğ—ˆğ—‡ğ—Œ:\nâ€¢ ğ–²ğ–¾ğ—‹ğ—ğ—‚ğ–¼ğ–¾ ğ—ğ–¾ğ—†ğ—‰ğ—ˆğ—‹ğ–ºğ—‹ğ—‚ğ—…ğ—’ ğ—ğ—‡ğ–ºğ—ğ–ºğ—‚ğ—…ğ–ºğ–»ğ—…ğ–¾\nâ€¢ ğ–¨ğ—‡ğ—ğ–ºğ—…ğ—‚ğ–½ ğ—‡ğ—ğ—†ğ–»ğ–¾ğ—‹ ğ–¿ğ—ˆğ—‹ğ—†ğ–ºğ—\nâ€¢ ğ–²ğ–¾ğ—‹ğ—ğ–¾ğ—‹ ğ–¼ğ—ˆğ—‡ğ—‡ğ–¾ğ–¼ğ—ğ—‚ğ—ˆğ—‡ ğ–¿ğ–ºğ—‚ğ—…ğ–¾ğ–½\n\nğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡ ğ—…ğ–ºğ—ğ–¾ğ—‹.`
                        );
                    }
                } catch (cleanupError) {
                    console.error("âŒ ğ–¢ğ—…ğ–¾ğ–ºğ—‡ğ—ğ—‰ ğ–¾ğ—‹ğ—‹ğ—ˆğ—‹:", cleanupError);
                }
            }, 90000);

        } catch (error) {
            console.error("ğŸ’¥ ğ–¢ğ–ºğ—…ğ—… ğ–¢ğ—ˆğ—†ğ—†ğ–ºğ—‡ğ–½ ğ–¤ğ—‹ğ—‹ğ—ˆğ—‹:", error);
            
            let errorMessage = "âŒ ğ– ğ—‡ ğ–¾ğ—‹ğ—‹ğ—ˆğ—‹ ğ—ˆğ–¼ğ–¼ğ—ğ—‹ğ—‹ğ–¾ğ–½. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡ ğ—…ğ–ºğ—ğ–¾ğ—‹.";
            
            if (error.code === 'ECONNREFUSED') {
                errorMessage = "âŒ ğ–²ğ–¾ğ—‹ğ—ğ—‚ğ–¼ğ–¾ ğ—ğ—‡ğ–ºğ—ğ–ºğ—‚ğ—…ğ–ºğ–»ğ—…ğ–¾. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡ ğ—…ğ–ºğ—ğ–¾ğ—‹.";
            } else if (error.code === 'ETIMEDOUT') {
                errorMessage = "âŒ ğ–±ğ–¾ğ—Šğ—ğ–¾ğ—Œğ— ğ—ğ—‚ğ—†ğ–¾ğ–½ ğ—ˆğ—ğ—. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡.";
            }
            
            await message.reply(errorMessage);
        }
    }
};
