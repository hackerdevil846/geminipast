const axios = require("axios");

module.exports = {
    config: {
        name: "coin",
        aliases: [],
        version: "1.2.0",
        author: "ğ´ğ‘ ğ‘–ğ‘“ ğ‘€ğ‘â„ğ‘šğ‘¢ğ‘‘",
        countDown: 3,
        role: 0,
        category: "economy",
        shortDescription: {
            en: "ğŸ’° ğ–¢ğ—ğ–¾ğ–¼ğ—„ ğ–¼ğ—ˆğ—‚ğ—‡ ğ–»ğ–ºğ—…ğ–ºğ—‡ğ–¼ğ–¾ğ—Œ ğ—‚ğ—‡ ğ—ğ—ğ–¾ ğ–¾ğ–¼ğ—ˆğ—‡ğ—ˆğ—†ğ—’ ğ—Œğ—’ğ—Œğ—ğ–¾ğ—†"
        },
        longDescription: {
            en: "ğŸ’° ğ–¢ğ—ğ–¾ğ–¼ğ—„ ğ–¼ğ—ˆğ—‚ğ—‡ ğ–»ğ–ºğ—…ğ–ºğ—‡ğ–¼ğ–¾ğ—Œ ğ—‚ğ—‡ ğ—ğ—ğ–¾ ğ–¾ğ–¼ğ—ˆğ—‡ğ—ˆğ—†ğ—’ ğ—Œğ—’ğ—Œğ—ğ–¾ğ—†"
        },
        guide: {
            en: "{p}coin [@ğ—†ğ–¾ğ—‡ğ—ğ—‚ğ—ˆğ—‡ | ğ—ğ–¾ğ—…ğ—‰]"
        },
        dependencies: {
            "axios": ""
        },
        envConfig: {}
    },

    onLoad: function() {
        console.log("âœ… ğ–¢ğ—ˆğ—‚ğ—‡ ğ–¼ğ—ˆğ—†ğ—†ğ–ºğ—‡ğ–½ ğ—…ğ—ˆğ–ºğ–½ğ–¾ğ–½ ğ—Œğ—ğ–¼ğ–¼ğ–¾ğ—Œğ—Œğ–¿ğ—ğ—…ğ—…ğ—’!");
    },

    onStart: async function({ message, event, args, usersData }) {
        try {
            // Dependency check
            let dependenciesAvailable = true;
            try {
                require("axios");
            } catch (e) {
                dependenciesAvailable = false;
            }

            if (!dependenciesAvailable) {
                return message.reply("âŒ ğ–¬ğ—‚ğ—Œğ—Œğ—‚ğ—‡ğ—€ ğ–½ğ–¾ğ—‰ğ–¾ğ—‡ğ–½ğ–¾ğ—‡ğ–¼ğ—‚ğ–¾ğ—Œ. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—‚ğ—‡ğ—Œğ—ğ–ºğ—…ğ—… ğ–ºğ—‘ğ—‚ğ—ˆğ—Œ.");
            }

            const { threadID, senderID, mentions } = event;

            if (args[0]?.toLowerCase() === "help") {
                const helpText = "ğŸ’ ğ–¢ğ–®ğ–¨ğ–­ ğ–¢ğ–®ğ–¬ğ–¬ğ– ğ–­ğ–£ ğ–§ğ–¤ğ–«ğ–¯\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n" +
                        "ğŸ“Œ ğ–¢ğ—ˆğ—†ğ—†ğ–ºğ—‡ğ–½ ğ–´ğ—Œğ–ºğ—€ğ–¾:\n" +
                        "â€¢ {p}ğ–¼ğ—ˆğ—‚ğ—‡ - ğ–¢ğ—ğ–¾ğ–¼ğ—„ ğ—’ğ—ˆğ—ğ—‹ ğ—ˆğ—ğ—‡ ğ–»ğ–ºğ—…ğ–ºğ—‡ğ–¼ğ–¾\n" +
                        "â€¢ {p}ğ–¼ğ—ˆğ—‚ğ—‡ @ğ—†ğ–¾ğ—‡ğ—ğ—‚ğ—ˆğ—‡ - ğ–¢ğ—ğ–¾ğ–¼ğ—„ ğ—Œğ—ˆğ—†ğ–¾ğ—ˆğ—‡ğ–¾ ğ–¾ğ—…ğ—Œğ–¾'ğ—Œ ğ–»ğ–ºğ—…ğ–ºğ—‡ğ–¼ğ–¾\n" +
                        "â€¢ {p}ğ–¼ğ—ˆğ—‚ğ—‡ ğ—ğ–¾ğ—…ğ—‰ - ğ–²ğ—ğ—ˆğ— ğ—ğ—ğ—‚ğ—Œ ğ—ğ–¾ğ—…ğ—‰ ğ—†ğ–¾ğ—Œğ—Œğ–ºğ—€ğ–¾\n\n" +
                        "ğŸ’¡ ğ– ğ–»ğ—ˆğ—ğ— ğ–¢ğ—ˆğ—‚ğ—‡ğ—Œ:\n" +
                        "â€¢ ğ–¢ğ—ˆğ—‚ğ—‡ğ—Œ ğ–ºğ—‹ğ–¾ ğ–¾ğ–ºğ—‹ğ—‡ğ–¾ğ–½ ğ—ğ—ğ—‹ğ—ˆğ—ğ—€ğ— ğ–ºğ–¼ğ—ğ—‚ğ—ğ—‚ğ—ğ—‚ğ–¾ğ—Œ, ğ—€ğ–ºğ—†ğ–¾ğ—Œ, ğ–ºğ—‡ğ–½ ğ—‹ğ–¾ğ—ğ–ºğ—‹ğ–½ğ—Œ\n" +
                        "â€¢ ğ–´ğ—Œğ–¾ ğ–¼ğ—ˆğ—‚ğ—‡ğ—Œ ğ—ğ—ˆ ğ—‰ğ—ğ—‹ğ–¼ğ—ğ–ºğ—Œğ–¾ ğ—‚ğ—ğ–¾ğ—†ğ—Œ, ğ—‰ğ—…ğ–ºğ—’ ğ—€ğ–ºğ—†ğ–¾ğ—Œ, ğ—ˆğ—‹ ğ–ºğ–¼ğ–¼ğ–¾ğ—Œğ—Œ ğ—‰ğ—‹ğ–¾ğ—†ğ—‚ğ—ğ—† ğ–¿ğ–¾ğ–ºğ—ğ—ğ—‹ğ–¾ğ—Œ\n" +
                        "â€¢ ğ–¢ğ—ğ–¾ğ–¼ğ—„ ğ—’ğ—ˆğ—ğ—‹ ğ–»ğ–ºğ—…ğ–ºğ—‡ğ–¼ğ–¾ ğ—‹ğ–¾ğ—€ğ—ğ—…ğ–ºğ—‹ğ—…ğ—’ ğ—ğ—ˆ ğ—ğ—‹ğ–ºğ–¼ğ—„ ğ—’ğ—ˆğ—ğ—‹ ğ–¾ğ–ºğ—‹ğ—‡ğ—‚ğ—‡ğ—€ğ—Œ!\n\n" +
                        "âœ¨ ğ–³ğ—‚ğ—‰: ğ–²ğ—ğ–ºğ—’ ğ–ºğ–¼ğ—ğ—‚ğ—ğ–¾ ğ—ğ—ˆ ğ–¾ğ–ºğ—‹ğ—‡ ğ—†ğ—ˆğ—‹ğ–¾ ğ–¼ğ—ˆğ—‚ğ—‡ğ—Œ ğ–½ğ–ºğ—‚ğ—…ğ—’!";
                return message.reply(helpText);
            }

            if (args.length === 0 || Object.keys(mentions).length === 0) {
                // Check own balance
                let userData;
                try {
                    userData = await usersData.get(senderID);
                } catch (dataError) {
                    console.error("âŒ ğ–¤ğ—‹ğ—‹ğ—ˆğ—‹ ğ—€ğ–¾ğ—ğ—ğ—‚ğ—‡ğ—€ ğ—ğ—Œğ–¾ğ—‹ ğ–½ğ–ºğ—ğ–º:", dataError);
                    return message.reply("âŒ ğ–£ğ– ğ–³ğ–  ğ–¤ğ–±ğ–±ğ–®ğ–±\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğ–¥ğ–ºğ—‚ğ—…ğ–¾ğ–½ ğ—ğ—ˆ ğ–ºğ–¼ğ–¼ğ–¾ğ—Œğ—Œ ğ—’ğ—ˆğ—ğ—‹ ğ–½ğ–ºğ—ğ–º. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡ ğ—…ğ–ºğ—ğ–¾ğ—‹.");
                }

                const balance = userData?.money || 0;
                const ownBalanceText = `ğŸ’° ğ–¸ğ–®ğ–´ğ–± ğ–¡ğ– ğ–«ğ– ğ–­ğ–¢ğ–¤\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸª™ | ğ–¸ğ—ˆğ— ğ–¼ğ—ğ—‹ğ—‹ğ–¾ğ—‡ğ—ğ—…ğ—’ ğ—ğ–ºğ—ğ–¾: ${balance.toLocaleString()} ğ–¼ğ—ˆğ—‚ğ—‡ğ—Œ\n\nğŸ’¹ | ğ–ªğ–¾ğ–¾ğ—‰ ğ–¾ğ–ºğ—‹ğ—‡ğ—‚ğ—‡ğ—€ ğ—†ğ—ˆğ—‹ğ–¾ ğ–¼ğ—ˆğ—‚ğ—‡ğ—Œ ğ—ğ—ğ—‹ğ—ˆğ—ğ—€ğ— ğ–ºğ–¼ğ—ğ—‚ğ—ğ—‚ğ—ğ—‚ğ–¾ğ—Œ!`;
                return message.reply(ownBalanceText);
            }

            // Check mentioned user's balance
            const targetID = Object.keys(mentions)[0];
            const targetName = mentions[targetID].replace(/@/g, "");
            
            // Validate target ID
            if (!targetID || isNaN(targetID)) {
                return message.reply("âŒ ğ–¨ğ–­ğ–µğ– ğ–«ğ–¨ğ–£ ğ–´ğ–²ğ–¤ğ–±\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—†ğ–¾ğ—‡ğ—ğ—‚ğ—ˆğ—‡ ğ–º ğ—ğ–ºğ—…ğ—‚ğ–½ ğ—ğ—Œğ–¾ğ—‹.");
            }

            let targetData;
            try {
                targetData = await usersData.get(targetID);
            } catch (targetError) {
                console.error("âŒ ğ–¤ğ—‹ğ—‹ğ—ˆğ—‹ ğ—€ğ–¾ğ—ğ—ğ—‚ğ—‡ğ—€ ğ—ğ–ºğ—‹ğ—€ğ–¾ğ— ğ—ğ—Œğ–¾ğ—‹ ğ–½ğ–ºğ—ğ–º:", targetError);
                return message.reply("âŒ ğ–´ğ–²ğ–¤ğ–± ğ–­ğ–®ğ–³ ğ–¥ğ–®ğ–´ğ–­ğ–£\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—†ğ–¾ğ—‡ğ—ğ—‚ğ—ˆğ—‡ ğ–º ğ—ğ–ºğ—…ğ—‚ğ–½ ğ—ğ—Œğ–¾ğ—‹ ğ—ğ—ˆ ğ–¼ğ—ğ–¾ğ–¼ğ—„ ğ—ğ—ğ–¾ğ—‚ğ—‹ ğ–»ğ–ºğ—…ğ–ºğ—‡ğ–¼ğ–¾");
            }

            if (!targetData) {
                return message.reply("âŒ ğ–´ğ–²ğ–¤ğ–± ğ–­ğ–®ğ–³ ğ–¥ğ–®ğ–´ğ–­ğ–£\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—†ğ–¾ğ—‡ğ—ğ—‚ğ—ˆğ—‡ ğ–º ğ—ğ–ºğ—…ğ—‚ğ–½ ğ—ğ—Œğ–¾ğ—‹ ğ—ğ—ˆ ğ–¼ğ—ğ–¾ğ–¼ğ—„ ğ—ğ—ğ–¾ğ—‚ğ—‹ ğ–»ğ–ºğ—…ğ–ºğ—‡ğ–¼ğ–¾");
            }

            const targetBalance = targetData.money || 0;
            const otherBalanceText = `ğŸ’° ğ–´ğ–²ğ–¤ğ–± ğ–¡ğ– ğ–«ğ– ğ–­ğ–¢ğ–¤\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ | ğ–´ğ—Œğ–¾ğ—‹: ${targetName}\nğŸª™ | ğ–¡ğ–ºğ—…ğ–ºğ—‡ğ–¼ğ–¾: ${targetBalance.toLocaleString()} ğ–¼ğ—ˆğ—‚ğ—‡ğ—Œ`;
            
            return message.reply({
                body: otherBalanceText,
                mentions: [{
                    tag: targetName,
                    id: targetID
                }]
            });

        } catch (error) {
            console.error("ğŸ’¥ ğ–¢ğ—ˆğ—‚ğ—‡ ğ–¼ğ—ˆğ—†ğ—†ğ–ºğ—‡ğ–½ ğ–¾ğ—‹ğ—‹ğ—ˆğ—‹:", error);
            
            let errorMessage = "âŒ ğ–¡ğ– ğ–«ğ– ğ–­ğ–¢ğ–¤ ğ–¤ğ–±ğ–±ğ–®ğ–±\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğ–¥ğ–ºğ—‚ğ—…ğ–¾ğ–½ ğ—ğ—ˆ ğ–¿ğ–¾ğ—ğ–¼ğ— ğ–»ğ–ºğ—…ğ–ºğ—‡ğ–¼ğ–¾. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡ ğ—…ğ–ºğ—ğ–¾ğ—‹.";
            
            if (error.message.includes('usersData')) {
                errorMessage = "âŒ ğ–£ğ– ğ–³ğ– ğ–²ğ–³ğ–®ğ–±ğ–¤ ğ–¤ğ–±ğ–±ğ–®ğ–±\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğ–¥ğ–ºğ—‚ğ—…ğ–¾ğ–½ ğ—ğ—ˆ ğ–ºğ–¼ğ–¼ğ–¾ğ—Œğ—Œ ğ—ğ—Œğ–¾ğ—‹ ğ–½ğ–ºğ—ğ–º. ğ–¯ğ—…ğ–¾ğ–ºğ—Œğ–¾ ğ—ğ—‹ğ—’ ğ–ºğ—€ğ–ºğ—‚ğ—‡ ğ—…ğ–ºğ—ğ–¾ğ—‹.";
            } else if (error.message.includes('permission')) {
                errorMessage = "âŒ ğ–¯ğ–¤ğ–±ğ–¬ğ–¨ğ–²ğ–²ğ–¨ğ–®ğ–­ ğ–¤ğ–±ğ–±ğ–®ğ–±\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğ–¨ğ—‡ğ—Œğ—ğ–¿ğ–¿ğ—‚ğ–¼ğ—‚ğ–¾ğ—‡ğ— ğ—‰ğ–¾ğ—‹ğ—†ğ—‚ğ—Œğ—Œğ—‚ğ—ˆğ—‡ğ—Œ ğ—ğ—ˆ ğ–ºğ–¼ğ–¼ğ–¾ğ—Œğ—Œ ğ—ğ—Œğ–¾ğ—‹ ğ–½ğ–ºğ—ğ–º.";
            }
            
            return message.reply(errorMessage);
        }
    }
};
